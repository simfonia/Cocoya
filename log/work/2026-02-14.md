# Cocoya 工作日誌 (2026-02-14)

## 本日進度
- **UI 工具列實作**：
    - 在 Webview 頂部加入工具列，包含：開新專案、開啟專案、儲存、另存、更新、關閉。
    - 使用指定 icons (new, load_project, save, save_as, published_with_changes, dangerous) 並實作 hover 切換效果。
- **檔案操作與通訊**：
    - 連結 Webview 與 Extension Host，實作 XML 專案檔的讀取與寫入。
    - 使用 VS Code 原生 `showOpenDialog` 與 `showSaveDialog` 確保使用者體驗一致。
- **髒狀態 (Dirty State) 追蹤**：
    - 監聽 Blockly 變動事件，當工作區修改時，「儲存」按鈕會出現粉紅底線標記。
    - 儲存後或載入檔案後自動清除髒狀態。
- **動作回饋**：
    - 模仿 piBlockly 實作按鈕點擊後的閃爍效果 (Flash effect)。
    - 「更新」動作會觸發 Extension 跳出提示訊息，並回傳成功狀態以清除閃爍。

## 變更檔案
- `media/index.html`: 加入工具列 HTML/CSS。
- `media/ui_manager.js`: 實作 `initToolbar`, `setDirty`, `flashButton`。
- `media/main.js`: 綁定事件監聽與 Host 訊息處理。
- `src/extension.ts`: 實作檔案操作 Command Handler。
- `media/zh-hant.js`: 更新語系與顏色定義。

## 核心架構重構 (Refactoring)
- **Extension Host (TS)**: 引入 CocoyaManager 類別，將通訊、檔案操作、執行管理與更新檢查模組化，解決程式碼過於臃腫的問題。
- **Webview Logic (JS)**: 引入 CocoyaApp 物件，實作結構化的生命週期管理，並強化異步載入的穩定性。
- **UI Manager (JS)**: 引入 CocoyaUI 物件，統一採用 camelCase 命名，補全 JSDoc 註解，並優化 DOM 操作效能。
- **i18n 全面化**: 實作語系同步機制，讓 VS Code 原生對話框也能支援多國語系顯示。

## 安全性與執行優化
- **指令安全**: 在執行 Python 程式前自動過濾定位標記 (\u0001ID:...), 確保產出純淨代碼。
- **路徑驗證**: 實作 Python 執行路徑的自動偵測與失效提示機制。
- **執行穩定性**: 優化 PowerShell 指令呼叫，解決路徑空格與自動中斷導致的終端機崩潰問題。

## 文件與規範
- **系統規格書**: 產出 docs/system_spec.html 電子書，定義變數命名、通訊協議與架構設計規範。
- **基礎文件**: 補全 LICENSE.md (MIT) 與 README.md。
- **打包流程**: 完成 sce 打包配置，可產出正式 VSIX 檔案。

## 平台與硬體支援 (Platform & Hardware)
- **模式切換系統**: 實作 Python (PC) 與 CircuitPython (MCU) 模式切換機制。
    - 支援模式鎖定 (Mode Locking)：切換模式時會強制要求建立新專案或存檔，確保環境純粹。
    - Toolbox 動態過濾：根據目前模式自動顯示/隱藏對應的積木分類。
    - 自動化入口：PC 模式預置 if __main__，MCU 模式預置 while True 迴圈。
- **序列埠管理 (Serial Port)**: 
    - 實作 Serial Port 偵測功能，透過 PowerShell 指令獲取系統 COM 埠列表。
    - 在工具列加入偵測按鈕與下拉選單，支援即時重新整理。

## UI/UX 深度優化
- **工具列佈局重整**: 
    - 引入分隔線與群組化設計，將功能劃分為「模式」、「檔案」、「設定」、「序列埠」與「執行」。
    - 實作「頁籤標題同步」：檔案名稱與髒狀態 (*) 現在直接顯示在 VS Code 頁籤上，移除工具列中央冗餘的狀態欄。
    - 優化按鈕間距與視覺重心，提升介面專業感。
- **視覺回饋強化**: 
    - 修正更新按鈕的 Hover 邏輯：最新版本時 Hover 變綠色圖示，有更新時 Hover 變紅色背景。
    - 實作選單取消回復機制：若在模式切換確認框選擇「取消」，選單會自動跳回原模式。

## 穩定性與型別修正
- **TypeScript 型別檢查**: 修正 extension.ts 中的隱式 ny 型別錯誤，確保編譯通過。
- **資源載入修正**: 解決 Webview 動態修改圖示 src 導致的 403 Forbidden 權限問題。

## CircuitPython 部署與監控 (MCU Deployment)
- **實作真實部署員**: 建立靜態 Python 腳本 esources/deploy_mcu.py，負責將程式碼傳輸至裝置。
- **智慧磁碟偵測**: 優先搜尋標籤為 CIRCUITPY 的磁碟機進行直接寫入，提升成功率。
- **Serial Monitor 整合**: 在部署完成後自動切換至監看模式，即時顯示 MCU 的 print() 輸出訊息於 VS Code 終端機。
- **REPL 錯誤捕捉**: 強化 Serial 傳輸協定，能主動捕捉並顯示 MCU 的磁碟唯讀錯誤 (OSError)。

## 專案模式自動化 (Project Intelligence)
- **XML 屬性標記**: 在存檔時自動將 platform="PC" 或 platform="CircuitPython" 注入 XML 根節點。
- **開啟自動偵測**: 實現「開檔即切換」，開啟專案時會根據 XML 屬性（或備援積木偵測）自動切換 Toolbox、模式選單與執行按鈕 Tooltip。
- **動態 UI 反饋**: 執行按鈕提示會隨模式改變（「執行 PC 端程式」或「上傳至 MCU」）。

## 系統清理與維護
- **目錄結構優化**: 將部署邏輯抽離至 esources/ 目錄，使 extension.ts 保持精簡。
- **磁碟空間管理**: 實作備份清理機制，僅保留最近 3 份核心備份。
- **暫存清理**: 確保執行前清空 	emp_scripts/ 確保環境純淨。
