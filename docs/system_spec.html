<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocoya 系統規格說明書</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #FE2F89;
            --sidebar-width: 280px;
            --bg-light: #f8f9fa;
            --text-main: #333;
        }

        body {
            font-family: "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
            margin: 0;
            display: flex;
            background-color: var(--bg-light);
            color: var(--text-main);
            line-height: 1.6;
        }

        /* 側邊導覽 */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--primary-color);
            color: white;
            position: fixed;
            overflow-y: auto;
            padding: 20px 0;
        }

        #sidebar h2 {
            padding: 0 25px;
            font-size: 1.2rem;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
        }

        #sidebar li a {
            display: block;
            padding: 12px 25px;
            color: #ecf0f1;
            text-decoration: none;
            transition: 0.3s;
            font-size: 0.95rem;
        }

        #sidebar li a:hover {
            background: var(--secondary-color);
            padding-left: 35px;
        }

        /* 主要內容區 */
        #content {
            margin-left: var(--sidebar-width);
            padding: 40px 60px;
            max-width: 1000px;
        }

        section {
            margin-bottom: 60px;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        h1 { font-size: 2.5rem; color: var(--primary-color); border-bottom: 3px solid var(--accent-color); padding-bottom: 10px; }
        h2 { font-size: 1.8rem; color: var(--secondary-color); margin-top: 0; border-left: 5px solid var(--accent-color); padding-left: 15px; }
        h3 { color: var(--primary-color); margin-top: 25px; }

        code { font-family: 'Consolas', monospace; background: #eee; padding: 2px 5px; border-radius: 4px; color: #d63384; }
        pre code { background: none; color: inherit; padding: 0; }

        .file-tree { background: #2d3436; color: #f1f2f6; padding: 20px; border-radius: 5px; font-family: monospace; }
        .spec-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .spec-table th, .spec-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .spec-table th { background-color: #f2f2f2; color: var(--primary-color); }

        .tag { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px; background: #e1e1e1; }
        .tag-ts { background: #3178c6; color: white; }
        .tag-js { background: #f7df1e; color: black; }
        .tag-py { background: #3776ab; color: white; }
        .tag-xml { background: #ff6600; color: white; }

        footer { text-align: center; margin-top: 40px; color: #888; font-size: 0.8rem; }
    </style>
</head>
<body>

<nav id="sidebar">
    <h2>Cocoya Spec</h2>
    <ul>
        <li><a href="#overview">1. 專案概述</a></li>
        <li><a href="#naming">2. 開發規範</a></li>
        <li><a href="#structure">3. 檔案架構 (v1.5 統整版)</a></li>
        <li><a href="#module-system">4. 模組化與平行載入</a></li>
        <li><a href="#i18n-dist">5. 語系分散化管理 (i18n)</a></li>
        <li><a href="#platform">6. 平台模式與自動偵測</a></li>
        <li><a href="#performance">7. 效能優化 (State Check)</a></li>
        <li><a href="#deployment">8. 硬體部署系統 (MCU)</a></li>
        <li><a href="#regex">9. 積木定位技術 (Regex)</a></li>
        <li><a href="#ai-spec">10. AI 視覺模組規範 (MediaPipe)</a></li>
        <li><a href="#indent-spec">11. 縮排與代碼產生規範</a></li>
        <li><a href="#async-dialogs">12. 非同步對話框機制 (Bridge)</a></li>
        <li><a href="#variable-mgmt">13. 變數管理與動態回調</a></li>
    </ul>
</nav>

<main id="content">
    <header>
        <h1>Cocoya 系統規格說明書 v2.2</h1>
        <p><strong>Code, Compute, Yield AI</strong> - 專為 AI 教育設計的視覺化開發環境。</p>
    </header>

    <section id="overview">
        <h2>1. 專案概述</h2>
        <p>Cocoya 是一個整合了 Blockly 與 Python (OpenCV/MediaPipe) 的 VS Code 擴充功能。它具備跨平台支援能力，可開發 PC 端 AI 程式或 CircuitPython 硬體程式。</p>
        <h3>核心技術</h3>
        <ul>
            <li><strong>Extension Host:</strong> TypeScript 4.9+ (VS Code API)</li>
            <li><strong>Frontend:</strong> Vanilla JavaScript (ES6)</li>
            <li><strong>Logic Engine:</strong> Google Blockly v12.x</li>
            <li><strong>Parallel Loading:</strong> Promise.all 模組載入機制</li>
        </ul>
    </section>

    <section id="naming">
        <h2>2. 開發規範</h2>
        <table class="spec-table">
            <thead>
                <tr><th>類型</th><th>規範</th><th>範例</th></tr>
            </thead>
            <tbody>
                <tr><td>類別名稱</td><td><code>PascalCase</code></td><td><code>CocoyaManager</code></td></tr>
                <tr><td>變數與函式</td><td><code>camelCase</code></td><td><code>isDirty</code>, <code>handleRunCode()</code></td></tr>
                <tr><td>轉義字元</td><td><code>JS String</code></td><td>磁碟 JS 呈現 <code>\n</code>，工具寫入時使用 <code>\\n</code></td></tr>
                <tr><td>模組 ID</td><td><code>path/pure_id</code></td><td><code>core/logic</code>, <code>cv_basic</code></td></tr>
            </tbody>
        </table>
    </section>

    <section id="structure">
        <h2>3. 檔案架構 (v1.5 統整版)</h2>
        <p>為了簡化路徑邏輯，所有積木模組統一放置於 <code>media/modules/</code> 目錄下。</p>
        <div class="file-tree">
            cocoya/media/modules/<br>
            ├── core/ (基礎核心模組)<br>
            │   ├── logic/ (blocks.js, generators.js, toolbox.xml, i18n/)<br>
            │   └── ...<br>
            ├── cv_basic/ (OpenCV 基礎操作)<br>
            ├── cv_draw/ (OpenCV 繪圖標註)<br>
            └── hardware/ (硬體控制模組)
        </div>
    </section>

    <section id="module-system">
        <h2>4. 模組化與平行載入</h2>
        <p>系統採用 <code>Promise.all</code> 平行載入所有模組。順序由 <code>core_manifest.json</code> 決定，確保 Toolbox 分類順序一致且載入效能最優化。</p>
        <h3>ID 命名慣例</h3>
        <p>檔案命名必須遵循 <code>[pure_id]_blocks.js</code> 與 <code>[pure_id]_generators.js</code>。載入器會自動根據 ID 分段 (split) 並提取最後一部分作為檔名。</p>
    </section>

    <section id="i18n-dist">
        <h2>5. 語系分散化管理 (i18n)</h2>
        <p>為了解決單一語系檔過大的問題，採用分散式儲存：</p>
        <ul>
            <li><strong>全域語系:</strong> 位於 <code>media/zh-hant.js</code>，定義 UI 按鈕、對話框與分類總稱。</li>
            <li><strong>模組語系:</strong> 位於 <code>modules/[moduleId]/i18n/[lang].js</code>，僅定義該模組特有的積木文字。</li>
        </ul>
        <p>載入器會在載入積木前，優先嘗試載入對應的模組語系檔。</p>
    </section>

    <section id="platform">
        <h2>6. 平台模式與自動偵測</h2>
        <p>Cocoya 支援 <strong>PC (Python)</strong> 與 <strong>CircuitPython (MCU)</strong> 雙模式隔離。</p>
        <p>模式資訊會自動注入 XML 屬性中，實現「開檔即鎖定模式」的功能。</p>
    </section>

    <section id="performance">
        <h2>7. 效能優化 (State Check)</h2>
        <p>積木啟用狀態 (孤兒檢查) 採用 <strong>Top-Down 遞迴演算法</strong>。運算量與頂層積木數成線性關係 ($O(N)$)，顯著改善大規模專案下的拖拽流暢度與垃圾桶動畫效能。</p>
    </section>

    <section id="deployment">
        <h2>8. 硬體部署系統 (MCU)</h2>
        <p>部署邏輯封裝於 <code>resources/deploy_mcu.py</code> 中，支援透過磁碟 (CIRCUITPY) 或 Serial REPL 進行傳輸，並整合即時 Monitor。</p>
    </section>

    <section id="regex">
        <h2>9. 積木定位技術 (Regex Deep Dive)</h2>
        <p>為了達成「積木」與「產出代碼」之間的精確導航，Cocoya 採用了雙軌 ID 注入機制。這套機制保證了 1:1 的行號對齊，且不破壞 Python 語法執行。</p>
        
        <h3>A. 運算式標記 (Invisible Markers)</h3>
        <p>用於行內拼入的積木（如變數、數值）。使用不可見字元包裹 ID，避免破壞運算子結構。</p>
        <ul>
            <li><strong>Regex:</strong> <code>\u0001ID:([\s\S]+?)\u0002</code></li>
            <li><strong>原理:</strong> 使用控制字元 <code>\u0001</code> (SOH) 與 <code>\u0002</code> (STX) 封裝。</li>
        </ul>

        <h3>B. 陳述句標記 (Trailing Comments)</h3>
        <p>用於完整的程式碼列（如 <code>import</code>, <code>if</code>）。將 ID 隱藏在行尾註解中。</p>
        <ul>
            <li><strong>Regex:</strong> <code>/  # ID:([^\s\n]+)/g</code></li>
            <li><strong>細節解析:</strong>
                <ul>
                    <li><code>  # ID:</code>: 以兩個空格開頭的 Python 註解，執行時會被忽略。</li>
                    <li><code>([^\s\n]+)</code>: 捕獲群組。匹配除空白與換行外的所有字元，確保能完整抓取包含特殊符號的 Blockly ID。</li>
                    <li><code>/g</code>: 全域匹配。當父子積木共用第一行代碼時（如 Global Definitions 容器），可同時抓取多個 ID 確保定位不失效。</li>
                </ul>
            </li>
        </ul>

        <h3>C. 處理流程 (The Workflow)</h3>
        <p>當 UI 渲染器處理每一行代碼時：</p>
        <ol>
            <li><strong>提取:</strong> 透過捕獲群組將 ID 存入映射表 (Map)，實現「點擊積木 -> 捲動至代碼行」的功能。</li>
            <li><strong>抹除:</strong> 使用 <code>.replace()</code> 將標記從字串中徹底刪除。</li>
            <li><strong>基準:</strong> 由於執行檔與預覽 UI 使用相同的「清理後字串」，行號誤差值為 0。</li>
        </ol>
    </section>

    <section id="ai-spec">
        <h2>10. AI 視覺模組規範 (MediaPipe)</h2>
        <p>為了確保 MediaPipe 與 OpenCV 的整合穩定性，AI 模組須遵循以下實作標準：</p>
        <ul>
            <li><strong>物件導向初始化:</strong> 產生器必須完整產出初始化代碼（包含 <code>import</code>、<code>mp.solutions</code> 初始化），以便使用者在全域定義區直接使用。</li>
            <li><strong>座標歸一化 (Normalization):</strong> 
                <ul>
                    <li>原始資料傳回 MediaPipe 座標 (0.0 - 1.0)。</li>
                    <li>提供專用的 <code>get_landmark_xy</code> 積木進行像素轉換。</li>
                </ul>
            </li>
            <li><strong>強型別連線檢查 (Type Safety):</strong> 
                <ul>
                    <li>偵測結果使用 <code>HandLandmarks</code> 與 <code>Landmark</code> 自定義類型。</li>
                    <li>確保「取得特徵點」積木與「座標轉換」積木之間的連線安全性。</li>
                </ul>
            </li>
        </ul>
    </section>

    <section id="indent-spec">
        <h2>11. 縮排與代碼產生規範</h2>
        <p>為了解決不同開發環境下的縮排位移問題，系統建立了嚴格的產生器標準：</p>
        
        <h3>A. 動態縮排 (Dynamic Indentation)</h3>
        <p>嚴禁在產生器中寫死空格（如 <code>'  pass\n'</code>）。必須使用 <code>generator.INDENT</code> 以對齊 UI 設定。</p>
        <pre><code class="language-javascript">// 正確做法
var branch = generator.statementToCode(block, 'DO') || generator.INDENT + 'pass\n';</code></pre>

        <h3>B. 全域定義區行為 (Definition Zone)</h3>
        <p><code>py_definition_zone</code> 積木具備<strong>自動移除縮排</strong>機制。它會根據當前系統的 <code>INDENT</code> 設定，自動裁切內部積木產出的縮排，使 <code>import</code> 與全域初始化代碼能正確靠左對齊。</p>

        <h3>C. 避免隱式注入</h3>
        <p>儘量避免使用 <code>generator.definitions_</code> 來注入長篇初始化代碼。這類代碼應透過「初始化積木」顯式產出，並建議使用者放置於「全域定義區」中，以維持 Preview 視窗中的代碼順序與可讀性。</p>
    </section>

    <section id="async-dialogs">
        <h2>12. 非同步對話框機制 (Bridge)</h2>
        <p>由於 VS Code Webview 禁止使用同步的 <code>window.prompt()</code>, <code>confirm()</code> 與 <code>alert()</code>，系統實作了一套跨端非同步橋樑：</p>
        <ul>
            <li><strong>核心技術:</strong> 透過 <code>Blockly.dialog.setPrompt()</code> 與 <code>setConfirm()</code> 攔截核心事件。</li>
            <li><strong>通訊流程:</strong> 
                <ol>
                    <li>Webview 發送 <code>postMessage</code> 至 Host。</li>
                    <li>Host 呼叫 <code>vscode.window.showInputBox</code> 或 <code>showInformationMessage</code>。</li>
                    <li>使用者輸入後，Host 回傳結果並帶上唯一的 <code>requestId</code>。</li>
                    <li>Webview 透過 <code>Map</code> 儲存的回調函式 (Callback) 異步完成操作。</li>
                </ol>
            </li>
            <li><strong>規範:</strong> 禁止在任何積木產生器或 UI 邏輯中使用同步彈窗，必須遵循此非同步回調規範。</li>
        </ul>
    </section>

    <section id="variable-mgmt">
        <h2>13. 變數管理與動態回調</h2>
        <p>為了解決變數建立與重新命名的同步性問題：</p>
        <ul>
            <li><strong>動態 Toolbox:</strong> 變數分類採用 <code>registerToolboxCategoryCallback</code> 動態產生，允許注入「建立變數」等自定義按鈕。</li>
            <li><strong>更名邏輯:</strong> 透過上述的非同步橋樑，系統能正確處理 Blockly 核心的「重新命名變數」選單，實現無感知的 Host-Webview 同步。</li>
        </ul>
    </section>

    <footer>
        <p>© 2026 simfonia - Cocoya 專案組。文件更新日期：2026-02-17 (v2.2)</p>
    </footer>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</body>
</html>
